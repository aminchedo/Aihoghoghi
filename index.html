<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›ï¸ Ø³ÛŒØ³ØªÙ… Ø¢Ø±Ø´ÛŒÙˆ Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†</title>
    
    <!-- Meta tags for SEO and social sharing -->
    <meta name="description" content="Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¢Ø±Ø´ÛŒÙˆ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù† Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ">
    <meta name="keywords" content="Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ÛŒ, Ø¢Ø±Ø´ÛŒÙˆ, ØªØ­Ù„ÛŒÙ„ Ù…ØªÙ†, Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ, Ø§ÛŒØ±Ø§Ù†">
    <meta name="author" content="Iranian Legal Archive Team">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Ø³ÛŒØ³ØªÙ… Ø¢Ø±Ø´ÛŒÙˆ Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†">
    <meta property="og:description" content="Ø³ÛŒØ³ØªÙ… Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¢Ø±Ø´ÛŒÙˆ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù† Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ø¢Ø±Ø´ÛŒÙˆ Ø­Ù‚ÙˆÙ‚ÛŒ">

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Load fonts and external resources -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind RTL Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'vazir': ['Vazirmatn', 'Tahoma', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-vazir bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen">
    <!-- Loading Screen -->
    <div id="loading-container" class="fixed inset-0 flex items-center justify-center z-50 bg-gradient-to-br from-blue-500 to-purple-600 transition-opacity duration-500">
        <div class="bg-white bg-opacity-10 backdrop-blur-xl rounded-3xl p-8 text-center shadow-2xl border border-white border-opacity-20 max-w-md w-11/12 animate-fade-in">
            <div class="text-6xl mb-6 animate-bounce-slow">âš–ï¸</div>
            <h1 class="text-2xl md:text-3xl font-bold mb-4 text-white">Ø³ÛŒØ³ØªÙ… Ø¢Ø±Ø´ÛŒÙˆ Ø§Ø³Ù†Ø§Ø¯ Ø­Ù‚ÙˆÙ‚ÛŒ Ø§ÛŒØ±Ø§Ù†</h1>
            <p class="text-lg opacity-90 mb-6 text-white">Ø³ÛŒØ³ØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªØ­Ù„ÛŒÙ„ Ùˆ Ø¢Ø±Ø´ÛŒÙˆ Ø§Ø³Ù†Ø§Ø¯</p>
            
            <!-- Loading Spinner -->
            <div class="w-16 h-16 border-4 border-white border-opacity-30 border-t-green-400 rounded-full animate-spin mx-auto mb-6"></div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-white bg-opacity-20 rounded-full h-2 mb-6 overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full transition-all duration-300 relative overflow-hidden" style="width: 0%">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white via-opacity-40 to-transparent animate-pulse"></div>
                </div>
            </div>
            
            <p id="loading-text" class="text-lg font-medium text-white animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÛŒØ³ØªÙ…...</p>
            
            <!-- File Status Grid -->
            <div id="file-status" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6 text-sm" style="display: none;">
                <div id="check-functional" class="bg-white bg-opacity-10 rounded-lg p-3 border border-white border-opacity-20">
                    <i class="fas fa-search ml-2"></i>
                    <span>functional_system.html</span>
                </div>
                <div id="check-working" class="bg-white bg-opacity-10 rounded-lg p-3 border border-white border-opacity-20">
                    <i class="fas fa-search ml-2"></i>
                    <span>working_system.html</span>
                </div>
                <div id="check-src" class="bg-white bg-opacity-10 rounded-lg p-3 border border-white border-opacity-20">
                    <i class="fas fa-search ml-2"></i>
                    <span>src/functional_system.html</span>
                </div>
                <div id="check-simple" class="bg-white bg-opacity-10 rounded-lg p-3 border border-white border-opacity-20">
                    <i class="fas fa-search ml-2"></i>
                    <span>simple_index.html</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Error Screen -->
    <div id="error-container" class="fixed inset-0 flex items-center justify-center z-40 bg-gradient-to-br from-red-500 to-purple-600 p-4" style="display: none;">
        <div class="bg-white bg-opacity-10 backdrop-blur-xl rounded-3xl p-8 text-center shadow-2xl border border-red-300 border-opacity-30 max-w-lg w-full animate-fade-in">
            <div class="text-6xl mb-6">âš ï¸</div>
            <h2 class="text-2xl font-bold mb-4 text-white">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÛŒØ³ØªÙ…</h2>
            <p class="text-lg mb-4 text-white opacity-90">Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆØ§Ù†Ø³ØªÛŒÙ… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ….</p>
            <div id="error-details" class="text-sm opacity-75 mb-6 text-white bg-black bg-opacity-20 rounded-lg p-3"></div>
            
            <div class="flex flex-col md:flex-row gap-3 justify-center">
                <button onclick="retryLoading()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                    <i class="fas fa-redo ml-2"></i>
                    ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
                </button>
                <button onclick="showManualOptions()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 transform hover:scale-105 hover:shadow-lg">
                    <i class="fas fa-list ml-2"></i>
                    Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ
                </button>
            </div>
        </div>
        
        <!-- Manual Options -->
        <div id="manual-options" class="absolute inset-x-4 bottom-4 bg-white bg-opacity-10 backdrop-blur-xl rounded-2xl p-6 border border-white border-opacity-20 animate-slide-up" style="display: none;">
            <h3 class="text-xl font-bold mb-4 text-white text-center">ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <a href="./working_system.html" class="block p-4 bg-blue-600 hover:bg-blue-700 rounded-xl transition-all duration-300 transform hover:scale-105 text-white">
                    <i class="fas fa-cogs ml-2"></i>
                    <span class="font-medium">working_system.html</span>
                    <div class="text-xs opacity-75 mt-1">Ø³ÛŒØ³ØªÙ… Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø§ØµÙ„ÛŒ</div>
                </a>
                <a href="./functional_system_backup.html" class="block p-4 bg-green-600 hover:bg-green-700 rounded-xl transition-all duration-300 transform hover:scale-105 text-white">
                    <i class="fas fa-file-code ml-2"></i>
                    <span class="font-medium">functional_system_backup.html</span>
                    <div class="text-xs opacity-75 mt-1">Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</div>
                </a>
                <a href="./simple_index.html" class="block p-4 bg-purple-600 hover:bg-purple-700 rounded-xl transition-all duration-300 transform hover:scale-105 text-white">
                    <i class="fas fa-home ml-2"></i>
                    <span class="font-medium">simple_index.html</span>
                    <div class="text-xs opacity-75 mt-1">Ø±Ø§Ø¨Ø· Ø³Ø§Ø¯Ù‡</div>
                </a>
                <a href="./test_ui.html" class="block p-4 bg-orange-600 hover:bg-orange-700 rounded-xl transition-all duration-300 transform hover:scale-105 text-white">
                    <i class="fas fa-vial ml-2"></i>
                    <span class="font-medium">test_ui.html</span>
                    <div class="text-xs opacity-75 mt-1">Ù†Ø³Ø®Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ</div>
                </a>
            </div>
        </div>
    </div>

    <script>
        // Configuration for intelligent routing
        const CONFIG = {
            // Files to check in order of priority
            filesToCheck: [
                { path: './functional_system.html', name: 'functional_system.html', priority: 1, description: 'ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø³ÛŒØ³ØªÙ…' },
                { path: './src/functional_system.html', name: 'src/functional_system.html', priority: 2, description: 'ÙØ§ÛŒÙ„ Ø¯Ø± Ù¾ÙˆØ´Ù‡ src' },
                { path: './working_system.html', name: 'working_system.html', priority: 3, description: 'Ø³ÛŒØ³ØªÙ… Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ' },
                { path: './functional_system_backup.html', name: 'functional_system_backup.html', priority: 4, description: 'Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†' },
                { path: './simple_index.html', name: 'simple_index.html', priority: 5, description: 'Ø±Ø§Ø¨Ø· Ø³Ø§Ø¯Ù‡' }
            ],
            
            // Persian loading messages
            loadingMessages: [
                'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³ÛŒØ³ØªÙ…...',
                'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...',
                'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ AI...',
                'Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…...',
                'Ø¯Ø± Ø­Ø§Ù„ ØªØ´Ø®ÛŒØµ Ù…Ø³ÛŒØ± Ø¨Ù‡ÛŒÙ†Ù‡...',
                'ØªÚ©Ù…ÛŒÙ„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ...'
            ],
            
            timeout: 12000, // 12 seconds timeout
            retryAttempts: 3,
            checkInterval: 800 // milliseconds between file checks
        };

        // Global variables
        let currentAttempt = 0;
        let progressValue = 0;
        let loadingMessageIndex = 0;
        let foundFile = null;
        let progressInterval = null;
        let messageInterval = null;

        // DOM elements
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        const fileStatus = document.getElementById('file-status');

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }

        function updateProgress(value) {
            progressValue = Math.min(value, 100);
            progressBar.style.width = progressValue + '%';
            
            // Add visual feedback
            if (progressValue === 100) {
                progressBar.classList.add('bg-gradient-to-r', 'from-green-400', 'to-green-600');
            }
        }

        function updateLoadingMessage() {
            if (loadingMessageIndex < CONFIG.loadingMessages.length) {
                loadingText.textContent = CONFIG.loadingMessages[loadingMessageIndex];
                loadingMessageIndex++;
            } else {
                // Cycle through messages
                loadingMessageIndex = 0;
                loadingText.textContent = CONFIG.loadingMessages[0];
            }
        }

        // Enhanced file checking with multiple methods
        async function checkFileExists(filePath) {
            const methods = [
                // Method 1: HEAD request
                async () => {
                    const response = await fetch(filePath, { 
                        method: 'HEAD',
                        cache: 'no-cache',
                        mode: 'no-cors'
                    });
                    return response.ok || response.type === 'opaque';
                },
                
                // Method 2: GET request with small range
                async () => {
                    const response = await fetch(filePath, { 
                        method: 'GET',
                        cache: 'no-cache',
                        headers: { 'Range': 'bytes=0-100' }
                    });
                    return response.ok || response.status === 206;
                },
                
                // Method 3: Simple GET request
                async () => {
                    const response = await fetch(filePath, { 
                        cache: 'no-cache'
                    });
                    return response.ok;
                }
            ];

            for (const method of methods) {
                try {
                    const result = await Promise.race([
                        method(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))
                    ]);
                    
                    if (result) {
                        log(`File found using method: ${filePath}`);
                        return true;
                    }
                } catch (error) {
                    log(`Method failed for ${filePath}: ${error.message}`, 'warn');
                }
            }
            
            return false;
        }

        // Update file status UI
        function updateFileStatus(fileName, found, isChecking = false) {
            const elementMap = {
                'functional_system.html': 'check-functional',
                'working_system.html': 'check-working',
                'src/functional_system.html': 'check-src',
                'simple_index.html': 'check-simple'
            };
            
            const elementId = elementMap[fileName];
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    if (isChecking) {
                        element.className = 'bg-yellow-500 bg-opacity-20 rounded-lg p-3 border border-yellow-400 border-opacity-30 animate-pulse';
                        element.querySelector('i').className = 'fas fa-spinner fa-spin ml-2';
                    } else if (found) {
                        element.className = 'bg-green-500 bg-opacity-20 rounded-lg p-3 border border-green-400 border-opacity-50';
                        element.querySelector('i').className = 'fas fa-check-circle ml-2 text-green-400';
                    } else {
                        element.className = 'bg-red-500 bg-opacity-20 rounded-lg p-3 border border-red-400 border-opacity-30';
                        element.querySelector('i').className = 'fas fa-times-circle ml-2 text-red-400';
                    }
                }
            }
        }

        // Main file detection and routing function
        async function detectAndRedirect() {
            try {
                currentAttempt++;
                log(`Starting file detection attempt ${currentAttempt}`);
                
                // Reset progress
                updateProgress(5);
                
                // Start progress animation
                progressInterval = setInterval(() => {
                    if (progressValue < 85) {
                        updateProgress(progressValue + Math.random() * 8);
                    }
                }, 400);
                
                // Start message rotation
                messageInterval = setInterval(updateLoadingMessage, 2000);
                
                // Show file status after 2 seconds
                setTimeout(() => {
                    fileStatus.style.display = 'grid';
                    fileStatus.classList.add('animate-slide-up');
                }, 2000);
                
                // Check files in order of priority
                for (let i = 0; i < CONFIG.filesToCheck.length; i++) {
                    const file = CONFIG.filesToCheck[i];
                    log(`Checking file ${i + 1}/${CONFIG.filesToCheck.length}: ${file.path}`);
                    
                    // Update UI to show current check
                    updateFileStatus(file.name, false, true);
                    updateProgress(20 + (i * 12));
                    loadingText.textContent = `Ø¨Ø±Ø±Ø³ÛŒ ${file.name}...`;
                    
                    try {
                        const exists = await checkFileExists(file.path);
                        updateFileStatus(file.name, exists, false);
                        
                        if (exists) {
                            log(`âœ… Found working file: ${file.path}`);
                            foundFile = file;
                            
                            // Complete progress with success
                            clearInterval(progressInterval);
                            clearInterval(messageInterval);
                            updateProgress(100);
                            loadingText.textContent = `âœ… ÙØ§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ ${file.name}...`;
                            
                            // Success animation
                            setTimeout(() => {
                                loadingContainer.classList.add('opacity-0');
                                setTimeout(() => {
                                    log(`Redirecting to: ${file.path}`);
                                    window.location.href = file.path;
                                }, 500);
                            }, 1500);
                            
                            return;
                        }
                    } catch (error) {
                        log(`Error checking ${file.path}: ${error.message}`, 'error');
                        updateFileStatus(file.name, false, false);
                    }
                    
                    // Small delay between checks for better UX
                    await new Promise(resolve => setTimeout(resolve, CONFIG.checkInterval));
                }
                
                // If no file found, show error
                throw new Error('Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
                
            } catch (error) {
                log(`Detection failed: ${error.message}`, 'error');
                clearInterval(progressInterval);
                clearInterval(messageInterval);
                showError(error.message);
            }
        }

        // Show error screen with details
        function showError(message) {
            loadingContainer.classList.add('opacity-0');
            setTimeout(() => {
                loadingContainer.style.display = 'none';
                errorContainer.style.display = 'flex';
                errorContainer.classList.add('animate-fade-in');
                document.getElementById('error-details').textContent = `Ø¬Ø²Ø¦ÛŒØ§Øª: ${message} | ØªÙ„Ø§Ø´ ${currentAttempt}/${CONFIG.retryAttempts}`;
            }, 500);
        }

        // Retry loading with enhanced logic
        function retryLoading() {
            if (currentAttempt >= CONFIG.retryAttempts) {
                showError('Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            log(`Retrying... Attempt ${currentAttempt + 1}/${CONFIG.retryAttempts}`);
            
            // Reset UI state
            errorContainer.style.display = 'none';
            loadingContainer.style.display = 'flex';
            loadingContainer.classList.remove('opacity-0');
            loadingContainer.classList.add('animate-fade-in');
            
            // Reset progress and messages
            progressValue = 0;
            loadingMessageIndex = 0;
            updateProgress(0);
            loadingText.textContent = CONFIG.loadingMessages[0];
            fileStatus.style.display = 'none';
            
            // Reset file status indicators
            ['check-functional', 'check-working', 'check-src', 'check-simple'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.className = 'bg-white bg-opacity-10 rounded-lg p-3 border border-white border-opacity-20';
                    const icon = element.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-search ml-2';
                    }
                }
            });
            
            // Start detection again with delay
            setTimeout(detectAndRedirect, 1500);
        }

        // Show manual file options
        function showManualOptions() {
            const manualOptions = document.getElementById('manual-options');
            manualOptions.style.display = 'block';
            manualOptions.classList.add('animate-slide-up');
        }

        // Emergency fallback system
        function emergencyFallback() {
            log('ğŸš¨ Emergency fallback activated', 'warn');
            
            const fallbackFiles = [
                './working_system.html',
                './functional_system_backup.html', 
                './simple_index.html',
                './test_ui.html',
                './dist/index.html'
            ];
            
            // Try each fallback file in sequence
            let fallbackIndex = 0;
            
            function tryNextFallback() {
                if (fallbackIndex >= fallbackFiles.length) {
                    showError('ØªÙ…Ø§Ù… Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
                    return;
                }
                
                const file = fallbackFiles[fallbackIndex];
                log(`Trying emergency fallback: ${file}`);
                
                loadingText.textContent = `ØªÙ„Ø§Ø´ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ: ${file}...`;
                
                // Try to navigate
                try {
                    window.location.href = file;
                } catch (error) {
                    log(`Emergency fallback failed for ${file}: ${error.message}`, 'error');
                    fallbackIndex++;
                    setTimeout(tryNextFallback, 1000);
                }
            }
            
            tryNextFallback();
        }

        // System initialization
        function initializeSystem() {
            log('ğŸ›ï¸ Iranian Legal Archive System - Starting initialization...');
            log(`Current URL: ${window.location.href}`);
            log(`User Agent: ${navigator.userAgent}`);
            log(`Screen: ${screen.width}x${screen.height}`);
            log(`Viewport: ${window.innerWidth}x${window.innerHeight}`);
            
            // Check network status
            if (!navigator.onLine) {
                showError('Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            // Start detection with initial delay
            setTimeout(() => {
                detectAndRedirect();
            }, 1200);
            
            // Set emergency fallback timeout
            setTimeout(() => {
                if (!foundFile) {
                    log('â° Timeout reached, activating emergency fallback');
                    emergencyFallback();
                }
            }, CONFIG.timeout);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM loaded, initializing system...');
            initializeSystem();
        });
        
        // Handle page visibility change (important for mobile)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && !foundFile && currentAttempt === 0) {
                log('Page became visible, reinitializing...');
                initializeSystem();
            }
        });

        // Network status monitoring
        window.addEventListener('online', () => {
            log('Network connection restored');
            if (!foundFile && currentAttempt > 0) {
                loadingText.textContent = 'Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...';
                setTimeout(retryLoading, 1000);
            }
        });

        window.addEventListener('offline', () => {
            log('Network connection lost', 'warn');
            loadingText.textContent = 'Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‚Ø·Ø¹ Ø´Ø¯Ù‡ Ø§Ø³Øª...';
            clearInterval(progressInterval);
            clearInterval(messageInterval);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'Escape':
                    showManualOptions();
                    break;
                case 'Enter':
                case ' ':
                    e.preventDefault();
                    if (errorContainer.style.display !== 'none') {
                        retryLoading();
                    }
                    break;
                case 'r':
                case 'R':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        window.location.reload();
                    }
                    break;
            }
        });

        // Enhanced error handling
        window.addEventListener('error', (e) => {
            log(`Uncaught error: ${e.error?.message || e.message}`, 'error');
            if (!foundFile) {
                showError(`Ø®Ø·Ø§ÛŒ Ø³ÛŒØ³ØªÙ…: ${e.error?.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'}`);
            }
        });

        window.addEventListener('unhandledrejection', (e) => {
            log(`Unhandled promise rejection: ${e.reason}`, 'error');
            if (!foundFile) {
                showError(`Ø®Ø·Ø§ÛŒ Promise: ${e.reason}`);
            }
        });

        // Service Worker registration for PWA support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        log('Service Worker registered successfully');
                    })
                    .catch(error => {
                        log(`Service Worker registration failed: ${error.message}`, 'warn');
                    });
            });
        }

        // Performance monitoring
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            log(`Page load completed in ${loadTime.toFixed(2)}ms`);
            
            // Log navigation timing if available
            if (performance.getEntriesByType) {
                const navigation = performance.getEntriesByType('navigation')[0];
                if (navigation) {
                    log(`Navigation timing - DNS: ${navigation.domainLookupEnd - navigation.domainLookupStart}ms, Connect: ${navigation.connectEnd - navigation.connectStart}ms`);
                }
            }
        });

        // Mobile-specific optimizations
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            log('Mobile device detected, applying optimizations');
            
            // Prevent zoom on input focus
            document.addEventListener('touchstart', () => {}, { passive: true });
            
            // Handle orientation change
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    log('Orientation changed, adjusting layout');
                }, 500);
            });
        }

        // Analytics and debugging helpers
        function getSystemInfo() {
            return {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                connection: navigator.connection ? navigator.connection.effectiveType : 'Unknown',
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : false
            };
        }

        // Log system info after initialization
        setTimeout(() => {
            log('ğŸ“Š System Information:');
            console.table(getSystemInfo());
        }, 3000);

        // Export functions for debugging
        window.legalArchiveDebug = {
            retryLoading,
            showManualOptions,
            getSystemInfo,
            checkFileExists,
            CONFIG
        };
    </script>
</body>
</html>