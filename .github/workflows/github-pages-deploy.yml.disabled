name: Deploy React App to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_ENV: production
  GITHUB_PAGES: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with npm ci..."
          npm ci --prefer-offline --no-audit

      - name: Build project
        run: |
          echo "ğŸ—ï¸ Building React/Vite project for production..."
          
          # Clean previous builds
          rm -rf dist/
          
          # Build with production optimizations
          npm run build
          
          # Verify build output
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed - index.html not found"
            exit 1
          fi
          
          echo "âœ… Build completed successfully"

      - name: Prepare for GitHub Pages
        run: |
          echo "ğŸ”§ Preparing build for GitHub Pages deployment..."
          
          # Create .nojekyll file to prevent Jekyll processing
          touch dist/.nojekyll
          
          # Copy 404.html for SPA routing support
          if [ -f "public/404.html" ]; then
            cp public/404.html dist/
            echo "âœ… Copied 404.html for SPA routing"
          fi
          
          # Copy manifest.json if not already copied
          if [ -f "public/manifest.json" ] && [ ! -f "dist/manifest.json" ]; then
            cp public/manifest.json dist/
            echo "âœ… Copied manifest.json"
          fi
          
          # Add security headers
          if [ ! -f "dist/_headers" ]; then
            cat > dist/_headers << 'EOF'
/*
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  Referrer-Policy: strict-origin-when-cross-origin
  Permissions-Policy: camera=(), microphone=(), geolocation=()

/assets/*
  Cache-Control: public, max-age=31536000, immutable

/*.html
  Cache-Control: public, max-age=3600

/manifest.json
  Cache-Control: public, max-age=86400

/sw.js
  Cache-Control: public, max-age=0, must-revalidate
EOF
            echo "âœ… Added security headers"
          fi
          
          # Display build statistics
          echo "ğŸ“Š Build Statistics:"
          echo "   Total files: $(find dist -type f | wc -l)"
          echo "   Total size: $(du -sh dist | cut -f1)"
          echo "   JS bundles: $(find dist/assets -name "*.js" 2>/dev/null | wc -l)"
          echo "   CSS files: $(find dist/assets -name "*.css" 2>/dev/null | wc -l)"
          
          # Verify critical files
          echo "ğŸ“‹ Critical files verification:"
          [ -f "dist/index.html" ] && echo "âœ… index.html exists" || echo "âŒ index.html missing"
          [ -f "dist/404.html" ] && echo "âœ… 404.html exists" || echo "âŒ 404.html missing"
          [ -f "dist/.nojekyll" ] && echo "âœ… .nojekyll exists" || echo "âŒ .nojekyll missing"
          [ -f "dist/manifest.json" ] && echo "âœ… manifest.json exists" || echo "âŒ manifest.json missing"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          force_orphan: true
          commit_message: "ğŸš€ Deploy Iranian Legal Archive - ${{ github.event.head_commit.message }}"
          cname: false

      - name: Deployment Success Notification
        run: |
          echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "================================="
          echo "ğŸ“± Application URL: https://aminchedo.github.io/Aihoghoghi/"
          echo "ğŸ”§ Optimized for Iranian users with fast loading"
          echo "âœ… SPA routing configured with 404.html"
          echo "âœ… RTL and Persian font support enabled"
          echo "âœ… Security headers configured"
          echo "âœ… PWA manifest included"
          echo "âœ… Service worker for offline support"
          echo ""
          echo "ğŸ”— Available Routes:"
          echo "   - /dashboard (Main dashboard)"
          echo "   - /search (Search database)"
          echo "   - /scraping (Scraping dashboard)"
          echo "   - /ai-analysis (AI analysis)"
          echo "   - /database (Database management)"
          echo "   - /settings (Settings panel)"