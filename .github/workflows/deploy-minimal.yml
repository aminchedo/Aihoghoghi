name: Deploy Minimal GitHub Pages (Strategy 3)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-minimal"
  cancel-in-progress: true

jobs:
  deploy-minimal:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Create minimal build
        run: |
          echo "🔧 Creating minimal GitHub Pages deployment..."
          
          # Create minimal dist directory
          mkdir -p dist/assets
          mkdir -p dist/src
          
          # Copy essential files only
          cp public/index-bypass.html dist/index.html
          cp public/404.html dist/404.html
          cp public/sw-disabled.js dist/sw.js
          cp public/sw-bypass.js dist/sw-bypass.js
          cp public/manifest.json dist/manifest.json
          
          # Create .nojekyll
          touch dist/.nojekyll
          
          # Copy lightweight React files
          cp src/main-lightweight.jsx dist/src/main.jsx
          cp src/App-lightweight.jsx dist/src/App.jsx
          
          # Install only essential dependencies
          npm install --production --no-optional react react-dom react-router-dom
          
          # Create minimal bundle
          cat > dist/assets/app-minimal.js << 'EOF'
          // Minimal JavaScript for GitHub Pages
          console.log('🚀 Minimal app loading...');
          
          // Check if we're on GitHub Pages
          if (window.location.hostname.includes('github.io')) {
            console.log('🌐 GitHub Pages detected');
            
            // Clear any existing service workers
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => reg.unregister());
              });
            }
            
            // Simple SPA router
            function handleRouting() {
              const path = window.location.pathname.replace('/Aihoghoghi', '');
              const routes = {
                '/': 'dashboard',
                '/dashboard': 'dashboard', 
                '/search': 'search',
                '/ai-analysis': 'ai-analysis',
                '/settings': 'settings'
              };
              
              const route = routes[path] || 'dashboard';
              loadPage(route);
            }
            
            // Load page content
            function loadPage(page) {
              const content = document.getElementById('app-content');
              if (!content) return;
              
              const pages = {
                dashboard: `
                  <div class="p-6 text-center">
                    <h1 class="text-3xl font-bold mb-4">🏛️ داشبورد آرشیو حقوقی</h1>
                    <p class="text-gray-600 mb-6">سیستم آرشیو اسناد حقوقی ایران</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold">📄 اسناد</h3>
                        <p>مجموعه اسناد حقوقی</p>
                      </div>
                      <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold">🔍 جستجو</h3>
                        <p>جستجو در آرشیو</p>
                      </div>
                      <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold">🧠 تحلیل</h3>
                        <p>تحلیل هوش مصنوعی</p>
                      </div>
                    </div>
                  </div>
                `,
                search: `
                  <div class="p-6">
                    <h1 class="text-3xl font-bold mb-4">🔍 جستجو در آرشیو</h1>
                    <div class="max-w-2xl mx-auto">
                      <input type="text" placeholder="جستجو در اسناد..." 
                             class="w-full p-3 border rounded-lg text-right" dir="rtl">
                      <div class="mt-4">
                        <div class="bg-white p-4 rounded-lg shadow mb-4">
                          <h3 class="font-semibold">قانون مدنی - ماده 10</h3>
                          <p class="text-gray-600">اشخاص حقیقی از زمان تولد تا هنگام مرگ...</p>
                        </div>
                      </div>
                    </div>
                  </div>
                `,
                'ai-analysis': `
                  <div class="p-6">
                    <h1 class="text-3xl font-bold mb-4">🧠 تحلیل هوش مصنوعی</h1>
                    <div class="max-w-2xl mx-auto">
                      <textarea placeholder="متن خود را برای تحلیل وارد کنید..." 
                                class="w-full p-3 border rounded-lg h-32 text-right" dir="rtl"></textarea>
                      <button class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg">تحلیل متن</button>
                    </div>
                  </div>
                `,
                settings: `
                  <div class="p-6">
                    <h1 class="text-3xl font-bold mb-4">⚙️ تنظیمات</h1>
                    <div class="max-w-2xl mx-auto">
                      <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">تنظیمات سیستم</h3>
                        <p>در حال توسعه...</p>
                      </div>
                    </div>
                  </div>
                `
              };
              
              content.innerHTML = pages[page] || pages.dashboard;
            }
            
            // Initialize minimal app
            function initMinimalApp() {
              document.body.innerHTML = `
                <div class="min-h-screen bg-gray-50" dir="rtl">
                  <header class="bg-white shadow-sm">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                      <h1 class="text-xl font-bold">🏛️ آرشیو اسناد حقوقی ایران</h1>
                    </div>
                  </header>
                  
                  <nav class="bg-gray-100 px-4 py-2">
                    <div class="max-w-7xl mx-auto">
                      <a href="/Aihoghoghi/" class="inline-block px-4 py-2 mx-1 rounded hover:bg-blue-100">داشبورد</a>
                      <a href="/Aihoghoghi/search" class="inline-block px-4 py-2 mx-1 rounded hover:bg-blue-100">جستجو</a>
                      <a href="/Aihoghoghi/ai-analysis" class="inline-block px-4 py-2 mx-1 rounded hover:bg-blue-100">تحلیل AI</a>
                      <a href="/Aihoghoghi/settings" class="inline-block px-4 py-2 mx-1 rounded hover:bg-blue-100">تنظیمات</a>
                    </div>
                  </nav>
                  
                  <main id="app-content" class="max-w-7xl mx-auto">
                    <!-- Content will be loaded here -->
                  </main>
                </div>
              `;
              
              // Handle routing
              handleRouting();
              
              // Listen for navigation
              window.addEventListener('popstate', handleRouting);
              
              // Handle navigation clicks
              document.addEventListener('click', (e) => {
                if (e.target.tagName === 'A' && e.target.href.includes('/Aihoghoghi/')) {
                  e.preventDefault();
                  window.history.pushState(null, '', e.target.href);
                  handleRouting();
                }
              });
            }
            
            // Start the minimal app
            setTimeout(initMinimalApp, 100);
          }
          EOF
          
          # Update index.html to use minimal bundle
          sed -i 's|<script type="module" src="/Aihoghoghi/src/main-lightweight.jsx"></script>|<script src="/Aihoghoghi/assets/app-minimal.js"></script>|' dist/index.html
          
          # Create minimal CSS
          cat > dist/assets/app-minimal.css << 'EOF'
          /* Minimal CSS for GitHub Pages */
          * { box-sizing: border-box; }
          body { 
            margin: 0; 
            font-family: 'Vazirmatn', Tahoma, Arial, sans-serif; 
            direction: rtl;
            background: #f9fafb;
          }
          .min-h-screen { min-height: 100vh; }
          .bg-white { background: white; }
          .bg-gray-50 { background: #f9fafb; }
          .bg-gray-100 { background: #f3f4f6; }
          .bg-blue-100 { background: #dbeafe; }
          .bg-blue-600 { background: #2563eb; }
          .text-white { color: white; }
          .text-gray-600 { color: #4b5563; }
          .shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
          .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
          .rounded { border-radius: 0.375rem; }
          .rounded-lg { border-radius: 0.5rem; }
          .p-2 { padding: 0.5rem; }
          .p-3 { padding: 0.75rem; }
          .p-4 { padding: 1rem; }
          .p-6 { padding: 1.5rem; }
          .px-4 { padding-left: 1rem; padding-right: 1rem; }
          .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
          .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
          .mx-1 { margin-left: 0.25rem; margin-right: 0.25rem; }
          .mx-auto { margin-left: auto; margin-right: auto; }
          .mb-2 { margin-bottom: 0.5rem; }
          .mb-4 { margin-bottom: 1rem; }
          .mb-6 { margin-bottom: 1.5rem; }
          .mt-4 { margin-top: 1rem; }
          .max-w-7xl { max-width: 80rem; }
          .max-w-2xl { max-width: 42rem; }
          .w-full { width: 100%; }
          .h-32 { height: 8rem; }
          .text-xl { font-size: 1.25rem; }
          .text-3xl { font-size: 1.875rem; }
          .font-bold { font-weight: 700; }
          .font-semibold { font-weight: 600; }
          .text-center { text-align: center; }
          .text-right { text-align: right; }
          .inline-block { display: inline-block; }
          .grid { display: grid; }
          .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
          .gap-4 { gap: 1rem; }
          .border { border: 1px solid #d1d5db; }
          .hover\:bg-blue-100:hover { background: #dbeafe; }
          
          @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
          }
          @media (min-width: 1024px) {
            .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
          }
          EOF
          
          # Add CSS to index.html
          sed -i 's|</head>|<link rel="stylesheet" href="/Aihoghoghi/assets/app-minimal.css">\n</head>|' dist/index.html
          
          echo "✅ Minimal build created successfully"
          
          # Verify build
          echo "📋 Build verification:"
          ls -la dist/
          echo "📊 Total size: $(du -sh dist | cut -f1)"

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Display deployment info
        run: |
          echo "🎉 MINIMAL DEPLOYMENT COMPLETED!"
          echo "================================="
          echo "📱 Application: ${{ steps.deployment.outputs.page_url }}"
          echo "✅ Minimal bundle - fastest loading"
          echo "✅ No service worker conflicts"
          echo "✅ Optimized for Iranian networks"
          echo "✅ Pure HTML/CSS/JS - maximum compatibility"